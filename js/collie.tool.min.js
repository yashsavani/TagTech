collie.FPSConsole=collie.Class({$init:function(a){this.option({color:"gray",left:10,top:10,useConsole:false,useDrawingCount:false,visible:true,limit:0,start:0,interval:60});
if(typeof a!=="undefined"){this.option(a)}this._elContainer=null;this._elParent=null;this._aList=[];this._bLoaded=false;this._bStart=false;
this._nWidth=100;this._nHeight=13;this._nPadding=2;this._nLastUpdatedFrame=0;this._htData={};this._htInfo={};this._htFPS={average:0,min:null,max:null,total:0,count:0};
this._htEvent={process:this._onProcess.bind(this),stop:this._onProcess.bind(this)};this.optionSetter("visible",function(b){if(!b){this._elContainer.style.display="none"
}else{this._elContainer.style.display="block"}}.bind(this));this._initElement()},_initElement:function(){this._elContainer=document.createElement("ul");
this._elContainer.id="__collie_fpsconsole";this._elContainer.style.position="absolute";this._elContainer.style.top=this.option("top")+"px";
this._elContainer.style.left=this.option("left")+"px";this._elContainer.style.margin="0";this._elContainer.style.padding="0";
this._elContainer.style.width=this._nWidth+"px";this._elContainer.style.height=this._nHeight+"px";this._elContainer.style.font="bold 0.75em Helvetica";
this._elContainer.style.color=this.option("color");this._elContainer.style.zIndex=9999;this._elContainer.style.display=(this.option("console")?"none":"block");
this.add("fps",0,"FPS");this.add("mode","")},load:function(a){if(typeof a!=="undefined"){this._elParent=a;this._elParent.appendChild(this._elContainer)
}collie.Renderer.attach(this._htEvent);this._bLoaded=true;return this},unload:function(){if(this._bLoaded){if(this._elParent!==null){this._elParent.removeChild(this._elContainer);
this._elParent=null}collie.Renderer.detach(this._htEvent);this._bLoaded=false;this._bStart=false}return this},getElement:function(){return this._elContainer
},add:function(f,e,a){if(f in this._htOption){throw new Error("Exists data name in FPSConsole");return false}var c=document.createElement("li");
c.style.listStyleType="none";c.style.height=this._nHeight+"px";c.style.paddingTop=this._nPadding+"px";c.innerHTML=(typeof a!=="undefined"?"<b>"+a+":</b> ":"");
var b=document.createElement("span");b.style.fontWeight="bold";b.innerHTML=e;c.appendChild(b);this._elContainer.appendChild(c);
var d=this._aList.push({name:f,value:e,element:b});this._elContainer.style.height=(d*this._nHeight)+"px";this._htData[f]=d-1;
return this},change:function(b,a){if(typeof this._htData[b]!=="undefined"){var c=this._aList[this._htData[b]];c.value=a;c.element.innerHTML=a
}},_onProcess:function(a){if(this._htOption.start>a.frame){return}if(!this._bStart){if(this._elParent===null){this._elParent=collie.Renderer.getElement();
this._elParent.appendChild(this._elContainer)}this.change("mode",this._setMode());this._bStart=true}this._setValue(a,a.type==="stop");
if(this._htOption.limit&&a.frame>this._htOption.limit){collie.Renderer.stop()}},_setMode:function(){var a=collie.Renderer.getRenderingMode()+(collie.Renderer.isRetinaDisplay()?"(retina)":"");
a=a.toUpperCase();return a},_setFPS:function(){return this._htInfo.fps},_setValue:function(b,a){this._htInfo.frame=b.frame;
this._htInfo.skippedFrame=b.skippedFrame;this._htInfo.fps=b.fps;this._htInfo.renderingTime=b.renderingTime;this._htFPS.total+=b.fps;
this._htFPS.count++;this._htInfo.fpsAverage=Math.round((this._htFPS.total/this._htFPS.count)*100)/100;this._htInfo.fpsMin=this._htFPS.min=this._htFPS.min!==null?Math.min(this._htFPS.min,b.fps):b.fps;
this._htInfo.fpsMax=this._htFPS.max=this._htFPS.max!==null?Math.max(this._htFPS.max,b.fps):b.fps;if(this._nLastUpdatedFrame>b.frame){this._nLastUpdatedFrame=0
}if(a||this._nLastUpdatedFrame+this._htOption.interval<=b.frame){this._update()}return this},_getValue:function(a){return !a?this._htInfo:this._htInfo[a]
},_update:function(){this.change("fps",this._setFPS());if(!this.option("visible")){if(this.option("useConsole")){for(var b=0,a=this._aList.length;
b<a;b++){console.log(this._aList[b].name+": "+this._aList[b].value)}}}else{if(this._bLoaded){this._nLastUpdatedFrame=this._htInfo.frame;
if(this._htOption.useDrawingCount){for(var b=0,a=collie.Renderer._aLayerList.length;b<a;b++){this._addDrawingCount(b);this.change("layer"+b,collie.Renderer._aLayerList[b].drawCount)
}}}}},_addDrawingCount:function(a){var b="layer"+a;if(!this._htData[b]){this.add(b,0,"#"+a)}}},collie.Component);(function(){var a={};
var c=[];var e=function(g){if(!a[g]){a[g]={name:g,startTime:null,totalTime:0,averageTime:0,count:0}}};var f=function(g){e(g);
if(a[g].startTime===null){a[g].startTime=(+new Date())}};var b=function(g){if(a[g].startTime!==null){a[g].totalTime+=(+new Date())-a[g].startTime;
a[g].count++;a[g].averageTime=a[g].totalTime/a[g].count;a[g].startTime=null}};var d=function(){for(var g in a){c.push(a[g])
}c.sort(function(i,h){return h.totalTime-i.totalTime})};collie.Profiling={setConsole:function(g){this._oConsole=g;this._oConsole.option("useConsole",false);
this._oConsole.option("visible",false)},load:function(k){if(k){collie.Renderer.attach("process",function(i){if(i.frame>k){collie.Profiling.getResults()
}})}for(var h in collie){if(typeof collie[h]==="object"){for(var g in collie[h]){if(!g.toString().match(/^\$super/)&&g!=="constructor"&&g!=="prototype"&&typeof collie[h][g]==="function"){(function(m,l){var o=m+"_"+l;
var n=collie[m][l];collie[m][l]=function(){f(o);var i=n.apply(this,arguments);b(o);return i}})(h,g)}}}if(typeof collie[h]!=="object"){for(var g in collie[h].prototype){if(!g.toString().match(/^\$super/)&&g!=="constructor"&&g!=="prototype"&&g!=="$init"&&typeof collie[h].prototype[g]==="function"){(function(m,l){var o=m+"_"+l;
var n=collie[m].prototype[l];collie[m].prototype[l]=function(){f(o);var i=n.apply(this,arguments);b(o);return i}})(h,g)}}}}},getResults:function(){collie.Renderer.stop();
d();this._showPage()},_showPage:function(){var m=navigator.userAgent;var h=window.devicePixelRatio;var k={width:document.body.clientWidth,height:document.body.clientHeight};
var l=document.createElement("div");l.style.cssText="position:absolute;top:0;left:0;width:"+k.width+"px;height:100%;background-color:#fff;padding:10px;line-height:1.5;font:1em Helvetica;";
var r=document.createElement("div");r.style.cssText="margin-bottom:15px;border-bottom:1px solid #aaa;padding-bottom:15px;";
r.innerHTML='<h1 style="margin-bottom:10px;">Collie Profiling</h1><div style="font-size:0.75em;color:gray;">ratio : '+h+", agent : "+m+"</div>";
l.appendChild(r);if(this._oConsole){this._oConsole.getElement().style.display="none";var s=document.createElement("ul");s.style.marginBottom="15px";
var g=this._oConsole._getValue();for(var n in g){s.innerHTML+='<li style="list-style-type:none;padding:3px;margin-bottom:3px;font-size:0.8em;"><strong>'+n+'</strong> <span style="color:gray;">'+this._oConsole._getValue(n)+"</span></li>"
}l.appendChild(s)}var q=document.createElement("ul");for(var p=0,u=Math.min(c.length,100);p<u;p++){var o=c[p].name.replace(/_/,".");
var t=(Math.round(c[p].averageTime*100)/100)+"ms / "+c[p].totalTime+"ms ("+c[p].count+")";q.innerHTML+='<li style="list-style-type:none;padding:3px;margin-bottom:3px;border-bottom:1px solid #aaa;font-size:0.75em;"><strong>'+o+'</strong> <span style="color:gray;">'+t+"</span></li>"
}l.appendChild(q);document.body.appendChild(l)}}})();