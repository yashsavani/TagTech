(function(){if(typeof Box2D==="undefined"){return}var j=Box2D.Common.Math.b2Vec2,b=Box2D.Collision.b2AABB,c=Box2D.Dynamics.b2BodyDef,i=Box2D.Dynamics.b2Body,d=Box2D.Dynamics.b2FixtureDef,f=Box2D.Dynamics.b2Fixture,l=Box2D.Dynamics.b2World,m=Box2D.Collision.Shapes.b2MassData,e=Box2D.Collision.Shapes.b2PolygonShape,k=Box2D.Collision.Shapes.b2CircleShape,h=Box2D.Dynamics.b2DebugDraw,a=Box2D.Dynamics.Joints.b2RevoluteJointDef,g=Box2D.Dynamics.Joints.b2MouseJointDef;
collie.Box2d=collie.Class({ITERATIONS_VELOCITY:6,ITERATIONS_POSITION:3,WIDTH_OF_WALL:10,$init:function(o,n,p){this._oDebugLayer=null;
this._oDebugDraw=null;this._bIsLoaded=false;this._bIsDebug=false;this._nStep=60;this._nWidth=0;this._nHeight=0;this._htFixtures={};
this._htBodies={};p=typeof p!=="undefined"?p:p||10;this._htWall={};this._oWorld=this.createWorld(p);this._fOnProcess=this._onProcess.bind(this);
this.resize(o,n)},getBody:function(o){var n=o.getId();return this._htBodies[n]||false},getDisplayObjectByBody:function(n){for(var o in this._htBodies){if(this._htBodies[o]===n){return collie.util.getDisplayObjectById(o)
}}},addFixture:function(p,o,q){if(q){o.shape=q}var n=this.createFixture(o);this._htFixtures[p]=n},removeFixture:function(n){delete this._htFixtures[n]
},getFixture:function(p){if(this._htFixtures[p]){var o=new d();for(var n in this._htFixtures[p]){o[n]=this._htFixtures[p][n]
}return o}else{return false}},createFixture:function(o){var n=new d();n.density=typeof o.density!=="undefined"?o.density:n.density;
n.filter=o.filter||n.filter;n.friction=typeof o.friction!=="undefined"?o.friction:n.friction;n.restitution=typeof o.restitution!=="undefined"?o.restitution:n.restitution;
n.isSensor=o.isSensor||n.isSensor;n.userData=o.userData||n.userData;n.shape=o.shape||n.shape;return n},createBody:function(o){var n=new c();
n.active=o.active||n.active;n.allowSleep=o.allowSleep||n.allowSleep;n.angle=o.angle||n.angle;n.angularDamping=o.angularDamping||n.angularDamping;
n.angularVelocity=o.angularVelocity||n.angularVelocity;n.awake=o.awake||n.awake;n.bullet=o.bullet||n.bullet;n.fixedRotation=o.fixedRotation||n.fixedRotation;
n.inertiaScale=o.inertiaScale||n.inertiaScale;n.linearDamping=o.linearDamping||n.linearDamping;n.linearVelocity=o.linearVelocity||n.linearVelocity;
n.position.x=o.x/collie.Box2d.SCALE||0;n.position.y=o.y/collie.Box2d.SCALE||0;switch(o.type){case"static":n.type=i.b2_staticBody;
break;case"kinematic":n.type=i.b2_kinematicBody;break;case"dynamic":default:n.type=i.b2_dynamicBody}n.userData=o.userData||n.userData;
return n},createObject:function(t,u,r){var s=t.get();var o=t.getId();u.x=s.x+s.width/2;u.y=s.y+s.height/2;var p=this.createBody(u);
var q=typeof r==="string"?this.getFixture(r):r;if("groupIndex" in u){q.filter.groupIndex=u.groupIndex}if(!q.shape){q.shape=this._createShape(t,u)
}var n=this._oWorld.CreateBody(p);this._htBodies[o]=n;n.CreateFixture(q);n._displayObjectId=o;return n},createStaticObject:function(r,q){var p;
r.type="static";r.x+=r.width/2;r.y+=r.height/2;if(!q){p=new d()}else{p=typeof q==="string"?this.getFixture(q):q}if(!p.shape){p.shape=this._createShape(null,r)
}var o=this.createBody(r);var n=this._oWorld.CreateBody(o);n.CreateFixture(p);return n},createWall:function(o,p){var n;switch(o){case"left":n=this.createStaticObject({x:-this.WIDTH_OF_WALL,y:-this.WIDTH_OF_WALL,width:this.WIDTH_OF_WALL,height:this._nHeight+this.WIDTH_OF_WALL*2},p);
break;case"right":n=this.createStaticObject({x:this._nWidth,y:-this.WIDTH_OF_WALL,width:this.WIDTH_OF_WALL,height:this._nHeight+this.WIDTH_OF_WALL*2},p);
break;case"top":n=this.createStaticObject({x:-this.WIDTH_OF_WALL,y:-this.WIDTH_OF_WALL,width:this._nWidth+this.WIDTH_OF_WALL*2,height:this.WIDTH_OF_WALL},p);
break;case"bottom":n=this.createStaticObject({x:-this.WIDTH_OF_WALL,y:this._nHeight,width:this._nWidth+this.WIDTH_OF_WALL*2,height:this.WIDTH_OF_WALL},p);
break;default:throw new Error("not invalid direction")}this._htWall[o]=n;return n},removeObject:function(o,p){var n=o._displayObjectId;
if(n){if(p){collie.util.getDisplayObjectById(n).leave()}delete this._htBodies[n]}this._oWorld.DestroyBody(o)},_createShape:function(o,p){var n;
if(("width" in p)&&("height" in p)){n=this._createShapeBox(p.width/collie.Box2d.SCALE,p.height/collie.Box2d.SCALE)}else{if(("radius" in p)){n=this._createShapeCircle(p.radius/collie.Box2d.SCALE)
}else{if(o){if(o instanceof collie.Circle){n=this._createShapeCircle(o._htOption.radius/collie.Box2d.SCALE)}else{n=this._createShapeBox(o._htOption.width/collie.Box2d.SCALE,o._htOption.height/collie.Box2d.SCALE)
}}}}return n},_createShapeBox:function(p,n){var o=new e();o.SetAsBox(p/2,n/2);return o},_createShapeCircle:function(n){return new k(n)
},createContact:function(q,o,r,n){var p=new Box2D.Dynamics.b2ContactListener();if(typeof q!=="undefined"){p.BeginContact=q
}if(typeof o!=="undefined"){p.EndContact=o}if(typeof r!=="undefined"){p.PostSolve=r}if(typeof n!=="undefined"){p.PreSolve=n
}this._oWorld.SetContactListener(p)},createRevoluteJoint:function(r,q,p,o){var n=new a();o=o||{};n.Initialize(r,q,p);n.enableLimit=typeof o.enableLimit!=="undefined"?o.enableLimit:n.enableLimit;
n.enableMotor=typeof o.enableMotor!=="undefined"?o.enableMotor:n.enableMotor;n.localAnchorA=typeof o.localAnchorA!=="undefined"?o.localAnchorA:n.localAnchorA;
n.localAnchorB=typeof o.localAnchorB!=="undefined"?o.localAnchorB:n.localAnchorB;n.lowerAngle=typeof o.lowerAngle!=="undefined"?o.lowerAngle:n.lowerAngle;
n.maxMotorTorque=typeof o.maxMotorTorque!=="undefined"?o.maxMotorTorque:n.maxMotorTorque;n.motorSpeed=typeof o.motorSpeed!=="undefined"?o.motorSpeed:n.motorSpeed;
n.referenceAngle=typeof o.referenceAngle!=="undefined"?o.referenceAngle:n.referenceAngle;n.upperAngle=typeof o.upperAngle!=="undefined"?o.upperAngle:n.upperAngle;
return this._oWorld.CreateJoint(n)},createDistanceJoint:function(s,r,q,o,p){var n=new Box2D.Dynamics.Joints.b2DistanceJointDef();
p=p||{};n.Initialize(s,r,q,o);n.dampingRatio=typeof p.dampingRatio!=="undefined"?p.dampingRatio:n.dampingRatio;n.frequencyHz=typeof p.frequencyHz!=="undefined"?p.frequencyHz:n.frequencyHz;
n.length=typeof p.length!=="undefined"?p.length:n.length;n.localAnchorA=typeof p.localAnchorA!=="undefined"?p.localAnchorA:n.localAnchorA;
n.localAnchorB=typeof p.localAnchorB!=="undefined"?p.localAnchorB:n.localAnchorB;return this._oWorld.CreateJoint(n)},createFrictionJoint:function(r,q,p,o){var n=new Box2D.Dynamics.Joints.b2FrictionJointDef();
o=o||{};n.Initialize(r,q,p);n.localAnchorA=typeof o.localAnchorA!=="undefined"?o.localAnchorA:n.localAnchorA;n.localAnchorB=typeof o.localAnchorB!=="undefined"?o.localAnchorB:n.localAnchorB;
n.maxForce=typeof o.maxForce!=="undefined"?o.maxForce:n.maxForce;n.maxTorque=typeof o.maxTorque!=="undefined"?o.maxTorque:n.maxTorque;
return this._oWorld.CreateJoint(n)},createGearJoint:function(p,o,n){var q=new Box2D.Dynamics.Joints.b2GearJointDef();q.joint1=o;
q.joint2=o;q.ratio=n;return this._oWorld.CreateJoint(q)},createLineJoint:function(s,r,p,q,o){var n=new Box2D.Dynamics.Joints.b2LineJointDef();
o=o||{};n.Initialize(s,r,p,q);n.enableLimit=typeof o.enableLimit!=="undefined"?o.enableLimit:n.enableLimit;n.enableMotor=typeof o.enableMotor!=="undefined"?o.enableMotor:n.enableMotor;
n.localAnchorA=typeof o.localAnchorA!=="undefined"?o.localAnchorA:n.localAnchorA;n.localAnchorB=typeof o.localAnchorB!=="undefined"?o.localAnchorB:n.localAnchorB;
n.localAxisA=typeof o.localAxisA!=="undefined"?o.localAxisA:n.localAxisA;n.lowerTranslation=typeof o.lowerTranslation!=="undefined"?o.lowerTranslation:n.lowerTranslation;
n.maxMotorForce=typeof o.maxMotorForce!=="undefined"?o.maxMotorForce:n.maxMotorForce;n.motorSpeed=typeof o.motorSpeed!=="undefined"?o.motorSpeed:n.motorSpeed;
n.upperTranslation=typeof o.upperTranslation!=="undefined"?o.upperTranslation:n.upperTranslation;return this._oWorld.CreateJoint(n)
},createMouseJoint:function(o,n,q){var p=new Box2D.Dynamics.Joints.b2MouseJointDef();q=q||{};p.bodyA=this._oWorld.GetGroundBody();
p.bodyB=o;p.target=n;p.dampingRatio=typeof q.dampingRatio!=="undefined"?q.dampingRatio:p.dampingRatio;p.frequencyHz=typeof q.frequencyHz!=="undefined"?q.frequencyHz:p.frequencyHz;
p.maxForce=typeof q.maxForce!=="undefined"?q.maxForce:p.maxForce;return this._oWorld.CreateJoint(p)},createPrismaticJoint:function(s,r,p,q,o){var n=new Box2D.Dynamics.Joints.b2PrismaticJointDef();
o=o||{};n.Initialize(s,r,p,q);n.enableLimit=typeof o.enableLimit!=="undefined"?o.enableLimit:n.enableLimit;n.enableMotor=typeof o.enableMotor!=="undefined"?o.enableMotor:n.enableMotor;
n.localAnchorA=typeof o.localAnchorA!=="undefined"?o.localAnchorA:n.localAnchorA;n.localAnchorB=typeof o.localAnchorB!=="undefined"?o.localAnchorB:n.localAnchorB;
n.localAxisA=typeof o.localAxisA!=="undefined"?o.localAxisA:n.localAxisA;n.lowerTranslation=typeof o.lowerTranslation!=="undefined"?o.lowerTranslation:n.lowerTranslation;
n.maxMotorForce=typeof o.maxMotorForce!=="undefined"?o.maxMotorForce:n.maxMotorForce;n.motorSpeed=typeof o.motorSpeed!=="undefined"?o.motorSpeed:n.motorSpeed;
n.referenceAngle=typeof o.referenceAngle!=="undefined"?o.referenceAngle:n.referenceAngle;n.upperTranslation=typeof o.upperTranslation!=="undefined"?o.upperTranslation:n.upperTranslation;
return this._oWorld.CreateJoint(n)},createPulleyJoint:function(s,r,u,t,q,p,o,v){var n=new Box2D.Dynamics.Joints.b2PulleyJointDef();
v=v||{};n.Initialize(s,r,u,t,q,p,o);n.lengthA=typeof v.lengthA!=="undefined"?v.lengthA:n.lengthA;n.lengthB=typeof v.lengthB!=="undefined"?v.lengthB:n.lengthB;
n.localAnchorA=typeof v.localAnchorA!=="undefined"?v.localAnchorA:n.localAnchorA;n.localAnchorB=typeof v.localAnchorB!=="undefined"?v.localAnchorB:n.localAnchorB;
n.maxLengthA=typeof v.maxLengthA!=="undefined"?v.maxLengthA:n.maxLengthA;n.maxLengthB=typeof v.maxLengthB!=="undefined"?v.maxLengthB:n.maxLengthB;
return this._oWorld.CreateJoint(n)},createWeldJoint:function(r,q,p,o){var n=new Box2D.Dynamics.Joints.b2WeldJointDef();o=o||{};
n.Initialize(r,q,p);n.localAnchorA=typeof o.localAnchorA!=="undefined"?o.localAnchorA:n.localAnchorA;n.localAnchorB=typeof o.localAnchorB!=="undefined"?o.localAnchorB:n.localAnchorB;
n.referenceAngle=typeof o.referenceAngle!=="undefined"?o.referenceAngle:n.referenceAngle;return this._oWorld.CreateJoint(n)
},removeJoint:function(n){this._oWorld.DestroyJoint(n)},createWorld:function(n){return new l(new j(0,n),true)},getWorld:function(){return this._oWorld
},load:function(n){if(!this._bIsLoaded){this._bIsLoaded=true;this._nStep=Math.round(1000/collie.Renderer.getDuration());if(n){this._setDebug(this._nWidth,this._nHeight)
}collie.Renderer.attach("process",this._fOnProcess)}},unload:function(){if(this._bIsLoaded){this._bIsLoaded=false;collie.Renderer.detach("process",this._fOnProcess);
this._unsetDebug()}},resize:function(q,p){var o,t,s,n;this._nWidth=q;this._nHeight=p;if(this._htWall){for(var r in this._htWall){switch(r){case"left":o=-this.WIDTH_OF_WALL+(this.WIDTH_OF_WALL/2);
t=-this.WIDTH_OF_WALL+((this._nHeight+this.WIDTH_OF_WALL*2)/2);s=this.WIDTH_OF_WALL;n=this._nHeight+this.WIDTH_OF_WALL*2;
break;case"right":o=this._nWidth+(this.WIDTH_OF_WALL/2);t=-this.WIDTH_OF_WALL+((this._nHeight+this.WIDTH_OF_WALL*2)/2);s=this.WIDTH_OF_WALL;
n=this._nHeight+this.WIDTH_OF_WALL*2;break;case"top":o=-this.WIDTH_OF_WALL+((this._nWidth+this.WIDTH_OF_WALL*2)/2);t=-this.WIDTH_OF_WALL+(this.WIDTH_OF_WALL/2);
s=this._nWidth+this.WIDTH_OF_WALL*2;n=this.WIDTH_OF_WALL;break;case"bottom":o=-this.WIDTH_OF_WALL+((this._nWidth+this.WIDTH_OF_WALL*2)/2);
t=this._nHeight+(this.WIDTH_OF_WALL/2);s=this._nWidth+this.WIDTH_OF_WALL*2;n=this.WIDTH_OF_WALL;break}o/=collie.Box2d.SCALE;
t/=collie.Box2d.SCALE;s/=collie.Box2d.SCALE;n/=collie.Box2d.SCALE;this._htWall[r].SetPosition(collie.Box2d.vec2(o,t));this._htWall[r].GetFixtureList().GetShape().SetAsBox(s/2,n/2)
}}},_setDebug:function(o,n){if(!this._bIsDebug){if(this._oDebugLayer===null){this._oDebugLayer=new collie.Layer({width:o,height:n})
}else{this._oDebugLayer.resize(o,n)}collie.Renderer.addLayer(this._oDebugLayer);if(this._oDebugDraw===null){this._oDebugDraw=new h();
this._oDebugDraw.SetSprite(this._oDebugLayer.getContext());this._oDebugDraw.SetDrawScale(30);this._oDebugDraw.SetFillAlpha(0.3);
this._oDebugDraw.SetLineThickness(1);this._oDebugDraw.SetFlags(h.e_shapeBit|h.e_jointBit);this._oWorld.SetDebugDraw(this._oDebugDraw)
}this._bIsDebug=true}},_unsetDebug:function(){if(this._bIsDebug){collie.Renderer.removeLayer(this._oDebugLayer);this._bIsDebug=false
}},_onProcess:function(p){var o=1/this._nStep;this._oWorld.Step(o,this.ITERATIONS_VELOCITY,this.ITERATIONS_POSITION);this._oWorld.ClearForces();
var n=this._oWorld.GetBodyList();if(n){do{if(n.IsActive()&&n._displayObjectId){this._update(n)}n=n.GetNext()}while(n)}if(this._bIsDebug){this._oWorld.DrawDebugData()
}},_update:function(n){var p=collie.util.getDisplayObjectById(n._displayObjectId);if(p){var o=p.get();var q=n.GetPosition();
p.set("angle",collie.util.toDeg(n.GetAngle()));p.set("x",(q.x-((o.width/collie.Box2d.SCALE)/2))*collie.Box2d.SCALE);p.set("y",(q.y-((o.height/collie.Box2d.SCALE)/2))*collie.Box2d.SCALE)
}else{this._oWorld.DestroyBody(n)}}});collie.Box2d.vec2=function(o,p,n){if(n){o/=collie.Box2d.SCALE;p/=collie.Box2d.SCALE
}return new j(o,p)};collie.Box2d.hasUserData=function(o){var n=o.GetUserData();return(typeof n!=="undefined")&&n!==null};
collie.Box2d.SCALE=30;collie.Box2d.BODY_TYPE={STATIC:"static",KINEMATIC:"kinematic",DYNAMIC:"dynamic"}})();collie.ImageNumber=collie.Class({$init:function(a){this._aNumber=[];
this._aComma=[];this._nIndexNumber=null;this._nIndexComma=null;this._nValue=null;this.option({textAlign:"left",letterSpacing:0,minDigit:0},null,true)
},setValue:function(b){this._nValue=Math.max(0,parseInt(b,10));this._nIndexNumber=null;this._nIndexComma=null;var j=this._nValue.toString();
var e=j.length;if(this._htOption.minDigit&&e<this._htOption.minDigit){j=(new Array(this._htOption.minDigit-e+1).join("0"))+j;
e=this._htOption.minDigit}var g=this._getWidth(j);var c=this._getStartPosition(g);var a=c+g;var h=0;var f=false;for(var d=e-1;
d>=0;d--){if(this._htOptionComma&&h%3===0&&h!==0){a=a-(this._htOptionComma.width+this._htOption.letterSpacing);this._getComma().set({x:a,visible:true})
}f=(h===0&&this._htOption.textAlign==="right")||(h===e&&this._htOption.textAlign==="left");a=a-(this._htOptionNumber.width+this._htOption.letterSpacing*(f?0:1));
this._getNumber().set({x:a,spriteX:parseInt(j.charAt(d),10),visible:true});h++}this._hideUnusedObject()},getValue:function(){return this._nValue
},number:function(a){this._htOptionNumber=a;return this},comma:function(a){if(!a){this._htOptionComma=null}else{if(!("width" in a)){throw new Error("comma method in ImageNumber requires a width property in options.")
}this._htOptionComma=a}if(this._nValue!==null){this.setValue(this._nValue)}return this},_getWidth:function(b){var c=b.toString();
var a=c.length*(this._htOptionNumber.width+this._htOption.letterSpacing);if(this._htOptionComma){a+=Math.max(0,Math.ceil(c.length/3-1))*(this._htOptionComma.width+this._htOption.letterSpacing)
}return a},_getStartPosition:function(a){switch(this._htOption.textAlign){case"right":return this._htOption.width-a;break;
case"center":return this._htOption.width/2-a/2;break;case"left":default:return 0}},_getNumber:function(){var a=this._nIndexNumber===null?0:this._nIndexNumber+1;
if(this._aNumber.length<a+1){this._aNumber.push(new collie.DisplayObject(this._htOptionNumber).addTo(this))}this._nIndexNumber=a;
return this._aNumber[a]},_getComma:function(){var a=this._nIndexComma===null?0:this._nIndexComma+1;if(this._aComma.length<a+1){this._aComma.push(new collie.DisplayObject(this._htOptionComma).addTo(this))
}this._nIndexComma=a;return this._aComma[a]},_hideUnusedObject:function(){for(var b=this._nIndexComma!==null?this._nIndexComma+1:0,a=this._aComma.length;
b<a;b++){this._aComma[b].set("visible",false)}if(this._nIndexNumber!==null){for(var b=this._nIndexNumber+1,a=this._aNumber.length;
b<a;b++){this._aNumber[b].set("visible",false)}}},toString:function(){return"ImageNumber"+(this.get("name")?" "+this.get("name"):"")+" #"+this.getId()+(this.getImage()?"(image:"+this.getImage().src+")":"")
}},collie.DisplayObject);collie.Pool=collie.Class({$init:function(b,c,a){this._nSize=b||0;this._htDefaultOption=c;this._aPool=[];
this._fClass=a||collie.DisplayObject;this._nLengthActiveObject=0;this._allocate()},_allocate:function(){var a=this._nLengthActiveObject+this._aPool.length;
if(this._nSize&&a<this._nSize){for(var b=a;b<this._nSize;b++){this._aPool.push(new this._fClass(this._htDefaultOption))}}},changeSize:function(a){this._nSize=a;
this._allocate()},getSize:function(){return this._nSize},changeOption:function(a){this._htDefaultOption=a},get:function(){if(!this._aPool.length){throw new Error("The Pool is empty")
}var a=this._aPool.pop();this._nLengthActiveObject++;return a},release:function(a){a.leave();this._nLengthActiveObject--;
this._aPool.push(a)}});collie.Sensor=collie.Class({RAY_SENSING_DISTANCE:10,$init:function(a){this.option({frequency:3,cacheSize:80,useDebug:false,debugListenerColor:"red",debugColor:"yellow",debugOpacity:0.5});
if(typeof a!=="undefined"){this.option(a)}this._nCurrentFrame=null;this._nAccumulateFrame=0;this._aListeners=[];this._htListenerCollision={};
this._htObject={};this._htCacheMap={};this._htCustomAreaCircle={};this._htCustomAreaBox={};this._fUpdate=this._onProcess.bind(this)
},update:function(d){if(this._nCurrentFrame===null||this._nCurrentFrame>d){this._nCurrentFrame=d}this._nAccumulateFrame+=(d-this._nCurrentFrame);
this._nCurrentFrame=d;if(this._nAccumulateFrame>=this._htOption.frequency){this._nAccumulateFrame=0;this._makeCacheMap();
this._htListenerCollisionBefore=this._htListenerCollision;this._htListenerCollision={};for(var c=0,a=this._aListeners.length;
c<a;c++){var e=this._aListeners[c];var b=this._getBoundary(e.displayObject);this._makeCustomArea(e.displayObject,b);this.detect(e.displayObject,e.category,b,e.beginCallback,e.endCallback)
}}},_getBoundary:function(f){var d=null;var g=null;var a=null;var b=null;var e;if(f._htBoundary!==null){d=f._htBoundary.left;
a=f._htBoundary.top;b=f._htBoundary.bottom;g=f._htBoundary.right;e=f._htBoundary.points}var c=f.getBoundary(true,true);if(d!==null&&(Math.abs(d-c.left)>=this.RAY_SENSING_DISTANCE||Math.abs(a-c.top)>=this.RAY_SENSING_DISTANCE)){e.push(c.points[0]);
e.push(c.points[1]);e.push(c.points[2]);e.push(c.points[3]);c.expanded={left:Math.min(d,c.left),right:Math.max(g,c.right),top:Math.min(a,c.top),bottom:Math.max(b,c.bottom),points:e,isExpanded:true}
}else{c.expanded=c;c.expanded.isExpanded=false}return c},_makeCustomArea:function(j,k){var d=j.getId();if(this._htCustomAreaBox[d]||this._htCustomAreaCircle[d]){k.isTransform=true;
k.centerX=k.points[0][0]+(k.points[2][0]-k.points[0][0])/2;k.centerY=k.points[0][1]+(k.points[2][1]-k.points[0][1])/2;if(this._htCustomAreaBox[d]){var g=Number.MAX_VALUE;
var e=Number.MAX_VALUE;var b=-Number.MAX_VALUE;var a=-Number.MAX_VALUE;for(var h=0,f=k.points.length;h<f;h++){var m=k.points[h];
var c=Math.atan2(k.centerY-m[1],k.centerX-m[0]);m[0]+=this._htCustomAreaBox[d]*Math.cos(c);m[1]+=this._htCustomAreaBox[d]*Math.sin(c);
g=Math.min(g,m[0]);b=Math.max(b,m[0]);e=Math.min(e,m[1]);a=Math.max(a,m[1])}k.left=g;k.right=b;k.top=e;k.bottom=a}}},_makeCacheMap:function(){var g;
var e;var d;var k;var j;for(var h in this._htObject){this._htCacheMap[h]={};for(var c=0,b=this._htObject[h].length;c<b;c++){g=this._htObject[h][c];
var f=this._getBoundary(g);e=Math.floor(f.expanded.left/this._htOption.cacheSize);k=Math.floor(f.expanded.right/this._htOption.cacheSize);
d=Math.floor(f.expanded.top/this._htOption.cacheSize);j=Math.floor(f.expanded.bottom/this._htOption.cacheSize);this._makeCustomArea(g,f);
for(var m=d;m<=j;m++){this._htCacheMap[h][m]=this._htCacheMap[h][m]||{};for(var a=e;a<=k;a++){this._htCacheMap[h][m][a]=this._htCacheMap[h][m][a]||[];
this._htCacheMap[h][m][a].push(g)}}}}},detect:function(h,b,n,k,u){if(b.indexOf(",")!==-1){var q=b.split(",");for(var p=0,j=q.length;
p<j;p++){this.detect(h,q[p],n,k,u)}}else{var s=Math.floor(n.expanded.left/this._htOption.cacheSize);var d=Math.floor(n.expanded.right/this._htOption.cacheSize);
var r=Math.floor(n.expanded.top/this._htOption.cacheSize);var a=Math.floor(n.expanded.bottom/this._htOption.cacheSize);var o=h.getId();
if(this._htCacheMap[b]){for(var g=r;g<=a;g++){for(var f=s;f<=d;f++){if(this._htCacheMap[b][g]&&this._htCacheMap[b][g][f]){for(var p=0,j=this._htCacheMap[b][g][f].length;
p<j;p++){var t=this._htCacheMap[b][g][f][p];var m=t.getId();if(this._htListenerCollision[o]&&this._htListenerCollision[o][m]){continue
}var e=this._hitTest(h,t,n,t._htBoundary);var c=(this._htListenerCollisionBefore[o]&&this._htListenerCollisionBefore[o][m]);
if(e){this._htListenerCollision[o]=this._htListenerCollision[o]||{};this._htListenerCollision[o][m]=true;if(!c){k(h,t)}}}}}}for(var m in this._htListenerCollisionBefore[o]){if(!this._htListenerCollision[o]||!this._htListenerCollision[o][m]){u(h,collie.util.getDisplayObjectById(m))
}}}}},_hitTest:function(g,f,m,k){var q=g.getId();var o=f.getId();if((m.expanded.left>k.expanded.right||k.expanded.left>m.expanded.right)||(m.expanded.top>k.expanded.bottom||k.expanded.top>m.expanded.bottom)){return false
}else{if(m.isTransform||k.isTransform||m.expanded.isExpanded||k.expanded.isExpanded){if(m.expanded.isExpanded||k.expanded.isExpanded||(!this._htCustomAreaCircle[q]&&!this._htCustomAreaCircle[o])){if((m.expanded.left<=k.expanded.left&&m.expanded.top<=k.expanded.top&&m.expanded.right>=k.expanded.right&&m.expanded.bottom>=k.expanded.bottom)||(m.expanded.left>k.expanded.left&&m.expanded.top>k.expanded.top&&m.expanded.right<k.expanded.right&&m.expanded.bottom<k.expanded.bottom)){return true
}for(var r=0,n=m.expanded.points.length;r<n;r++){var u=m.expanded.points[r];var t=m.expanded.points[(r===n-1)?0:r+1];for(var p=0,s=k.expanded.points.length;
p<s;p++){var d=k.expanded.points[p];var c=k.expanded.points[(p===s-1)?0:p+1];if(this._isIntersectLine(u,t,d,c)){return true
}}}}else{if(this._htCustomAreaCircle[q]&&this._htCustomAreaCircle[o]){return collie.util.getDistance(m.centerX,m.centerY,k.centerX,k.centerY)<=this._htCustomAreaCircle[q]+this._htCustomAreaCircle[o]
}else{var h;var b;var a;if(this._htCustomAreaCircle[o]){h=m;b=k;a=this._htCustomAreaCircle[o]}else{h=k;b=m;a=this._htCustomAreaCircle[q]
}for(var r=0,n=h.points.length;r<n;r++){var u=m.points[r];var t=m.points[(r===n-1)?0:r+1];var e=Math.atan((b.centerY-u[1])/(b.centerX-u[0]));
e-=Math.atan((t[1]-u[1])/(t[0]-u[0]));if(Math.sin(e)*collie.util.getDistance(b.centerX,b.centerY,u[0],u[1])<=a){return true
}}return false}}return false}else{return true}}},_isIntersectLine:function(b,a,e,d){var c=(d[1]-e[1])*(a[0]-b[0])-(d[0]-e[0])*(a[1]-b[1]);
if(c===0){return false}var f=(d[0]-e[0])*(b[1]-e[1])-(d[1]-e[1])*(b[0]-e[0]);var g=(a[0]-b[0])*(b[1]-e[1])-(a[1]-b[1])*(b[0]-e[0]);
var h=f/c;var i=g/c;if((h<0||h>1||i<0||i>1)||(f===0&&g===0)){return false}return true},addListener:function(f,e,a,c,d,b){this._aListeners.push({category:e,displayObject:f,beginCallback:a,endCallback:c});
this._addCustomArea(f,d,b);if(this._htOption.useDebug){this._drawArea(f,true,d,b)}},add:function(g,f,e,b){if(f.indexOf(",")!==-1){var c=f.split(",");
for(var d=0,a=c.length;d<a;d++){this.add(g,c[d],e,b)}}else{this._htObject[f]=this._htObject[f]||[];this._htObject[f].push(g);
this._addCustomArea(g,e,b);if(this._htOption.useDebug){this._drawArea(g,false,e,b)}}},remove:function(e,d){if(!d){for(var c in this._htObject){this.remove(e,c)
}}else{if(d.indexOf(",")!==-1){var b=d.split(",");for(var c=0,a=b.length;c<a;c++){this.remove(e,b[c])}}else{if(this._htObject[d]){for(var c=0,a=this._htObject[d].length;
c<a;c++){if(this._htObject[d][c]===e){if(this._htCustomAreaCircle[e.getId()]){delete this._htCustomAreaCircle[e]}if(this._htCustomAreaBox[e.getId()]){delete this._htCustomAreaBox[e]
}this._htObject[d].splice(c,1);break}}}}}},_addCustomArea:function(c,b,a){if(typeof a!=="undefined"){this._htCustomAreaBox[c.getId()]=Math.sqrt(Math.pow(b,2)+Math.pow(a,2))
}else{if(typeof b!=="undefined"){this._htCustomAreaCircle[c.getId()]=b}}},start:function(){collie.Renderer.attach("process",this._fUpdate)
},stop:function(){collie.Renderer.detach("process",this._fUpdate);this._nCurrentFrame=null;this._nAccumulateFrame=0},_onProcess:function(a){this.update(a.frame)
},_drawArea:function(d,f,c,a){var b=f?this._htOption.debugListenerColor:this._htOption.debugColor;var g=d.getId();if(this._htCustomAreaCircle[g]){var e=new collie.Circle({radius:this._htCustomAreaCircle[g],fillColor:b,opacity:this._htOption.debugOpacity}).addTo(d);
e.center(d._htOption.width/2,d._htOption.height/2)}else{if(this._htCustomAreaBox[g]){new collie.DisplayObject({x:c,y:a,width:d._htOption.width-c*2,height:d._htOption.height-a*2,backgroundColor:b,opacity:this._htOption.debugOpacity}).addTo(d)
}else{new collie.DisplayObject({width:d._htOption.width,height:d._htOption.height,backgroundColor:b,opacity:this._htOption.debugOpacity}).addTo(d)
}}}},collie.Component);collie.Map=collie.Class({$init:function(b,a,c){this._oLayer=null;this._oObjectLayer=null;this._fOnMousemove=this._onMousemove.bind(this);
this._fOnMouseup=this._onMouseup.bind(this);this._fOnMousedown=this._onMousedown.bind(this);this._fOnClick=this._onClick.bind(this);
this._fOnResize=this._onResize.bind(this);this._nTileWidth=b;this._nTileHeight=a;this._nStartMouseX=null;this._nStartMouseY=null;
this._nStartContainerX=null;this._nStartContainerY=null;this._bIsMousedown=false;this._bLockScreen=false;this._nRowLength=0;
this._nColLength=0;this._aMapData=[];this._aTiles=[];this._htTile={};this._htObject={};this._htEventInfo={};this._sRenderingMode=null;
this._oPool=new collie.Pool();this._oContainer=new collie.DisplayObject();this._htContainerInfo=this._oContainer.get();this._oObjectContainer=new collie.DisplayObject();
this._htLayerOption=null;this.option({cacheTileSize:1,useCache:false,updateInterval:150,useLiveUpdate:false,useEvent:true,useLimitMoving:true});
this._oTimerUpdate=collie.Timer.repeat(this._prepareTile.bind(this),this._htOption.updateInterval,{useAutoStart:false});this.optionSetter("useEvent",this._setterUseEvent.bind(this));
this.optionSetter("updateInterval",function(d){this._oTimerUpdate.setDuration(d)}.bind(this));if(typeof c!=="undefined"){this.option(c)
}this._setterUseEvent(this._htOption.useEvent)},addTo:function(a){this.setLayer(a);return this},addObjectTo:function(a){this.setObjectLayer(a);
return this},setLayer:function(a){if(this._oLayer!==null){this.unsetLayer()}if(a.getRenderingMode()==="dom"&&!collie.util.getDeviceInfo().desktop){throw new Error("The collie.Map doesn't support DOM mode in mobile devices")
}this._oLayer=a;this._htLayerOption=this._oLayer._htOption;this._sRenderingMode=this._oLayer.getRenderingMode();this._oLayer.attach("resize",this._fOnResize);
if(this._htOption.useEvent){this._oLayer.attach("mousemove",this._fOnMousemove);this._oLayer.attach("mouseup",this._fOnMouseup);
this._oLayer.attach("mousedown",this._fOnMousedown);this._oLayer.attach("click",this._fOnClick)}this._oContainer.addTo(a);
this._prepareStage()},_prepareStage:function(){var b=this._htLayerOption.width;var d=this._htLayerOption.height;var c=false;
var a=0;if(this._htOption.useCache&&this._sRenderingMode==="canvas"){b=this._nTileWidth*this._nColLength,d=this._nTileHeight*this._nRowLength,c=true;
a=this._nColLength*this._nRowLength}else{var f=Math.ceil(this._htLayerOption.width/this._nTileWidth)+2;var e=Math.ceil(this._htLayerOption.height/this._nTileHeight)+2;
a=(f+this._htOption.cacheTileSize*2)*(e+this._htOption.cacheTileSize*2)}this._oContainer.set({width:b,height:d,useCache:c});
this._oPool.changeSize(a);if(c){this._prepareTileWithCache()}else{this._prepareTile()}},unsetLayer:function(){if(this._oLayer!==null){this._oLayer.detach("resize",this._fOnResize);
if(this._htOption.useEvent){this._oLayer.detach("mousemove",this._fOnMousemove);this._oLayer.detach("mouseup",this._fOnMouseup);
this._oLayer.detach("mousedown",this._fOnMousedown);this._oLayer.detach("click",this._fOnClick)}this._oContainer.leave();
this._oLayer=null;this._sRenderingMode=null}},setObjectLayer:function(a){if(this._oObjectLayer!==null){this.unsetObjectLayer()
}this._oObjectLayer=a;this._oObjectContainer.addTo(this._oObjectLayer);this._oObjectContainer.set({width:this._oObjectLayer._htOption.width,height:this._oObjectLayer._htOption.height})
},unsetObjectLayer:function(){if(this._oObjectLayer!==null){this._oObjectContainer.leave();this._oObjectLayer=null}},getContainer:function(){return this._oContainer
},getObjectContainer:function(){return this._oObjectContainer},setPosition:function(b,a){if(this._bLockScreen){return false
}if(this._htOption.useLimitMoving){b=Math.max(-this._nColLength*this._nTileWidth+this._htLayerOption.width,b);a=Math.max(-this._nRowLength*this._nTileHeight+this._htLayerOption.height,a);
b=Math.min(0,b);a=Math.min(0,a)}b=Math.round(b);a=Math.round(a);this._oContainer.set("x",b);this._oContainer.set("y",a);this._htEventInfo.x=b;
this._htEventInfo.y=a;if(this._oObjectLayer!==null){this._oObjectContainer.set("x",b);this._oObjectContainer.set("y",a)}},getPosition:function(){return{x:this._htContainerInfo.x,y:this._htContainerInfo.y}
},getTileXLength:function(){return this._nColLength},getTileYLength:function(){return this._nRowLength},setMapData:function(c){this._aMapData=c;
for(var e=0,a=this._aMapData.length;e<a;e++){for(var d=0,b=this._aMapData[e].length;d<b;d++){this._appendTileOption(d,e,this._aMapData[e][d])
}}this._cacheTileLength();this._prepareStage()},unsetMapData:function(){this._aMapData=null},addTile:function(b,a,c){c=c||{};
this._aMapData[a]=this._aMapData[a]||[];if(this._aMapData[a][b]){this.removeTile(b,a)}this._appendTileOption(b,a,c);this._aMapData[a][b]=c;
this._cacheTileLength()},_appendTileOption:function(b,a,c){c.width=this._nTileWidth;c.height=this._nTileHeight;c.x=b*this._nTileWidth;
c.y=a*this._nTileHeight;c.tileX=b;c.tileY=a},addObject:function(b,a,c){if(typeof c._htOption.tileX!=="undefined"&&c._htOption.tileX!==null){this.removeObject(c)
}c.set("mapObject",this);this._addObjectToTile(b,a,c)},isVisibleOffset:function(b,a){return(this._htOption.useCache&&this._sRenderingMode==="canvas")||(this._htEventInfo.startTileX<=b&&this._htEventInfo.endTileX>=b&&this._htEventInfo.startTileY<=a&&this._htEventInfo.endTileY>=a)
},_addObjectToTile:function(b,a,c){this._htObject[a]=this._htObject[a]||{};this._htObject[a][b]=this._htObject[a][b]||[];
this._htObject[a][b].push(c);c.set("tileX",b);c.set("tileY",a);if(!c.getParent()&&this.isVisibleOffset(b,a)){c.addTo(this._oObjectContainer)
}},moveObject:function(b,a,c){if(typeof c._htOption.tileX!=="undefined"&&c._htOption.tileX!==null){this._removeObjectFromTile(c,this.isVisibleOffset(b,a));
this._addObjectToTile(b,a,c)}},removeObject:function(a){a.leave();a.set("mapObject",null);this._removeObjectFromTile(a)},_removeObjectFromTile:function(f,b){var e=f._htOption.tileX;
var c=f._htOption.tileY;f.set("tileX",null);f.set("tileY",null);if(this._htObject[c]&&this._htObject[c][e]){for(var d=0,a=this._htObject[c][e].length;
d<a;d++){if(this._htObject[c][e][d]===f){this._htObject[c][e].splice(d,1);break}}}if(!b&&!this.isVisibleOffset(e,c)&&f.getParent()){f.leave()
}},lock:function(){this._bLockScreen=true;return this},unlock:function(){this._bLockScreen=false;return this},_getTileZIndex:function(b,a){return 10+a
},_cacheTileLength:function(){this._nRowLength=this._aMapData.length;this._nColLength=this._aMapData[this._nRowLength-1].length
},removeTile:function(b,a){if(this._aMapData[a]&&this._aMapData[a][b]){delete this._aMapData[a][b]}},changeTile:function(d,b,e){var a=this.getTile(d,b);
if(a&&e){for(var c in e){a[c]=e[c]}if(this._htTile[b]&&this._htTile[b][d]){this._htTile[b][d].set(e)}}},getTile:function(b,a){return(this._aMapData[a]&&this._aMapData[a][b])?this._aMapData[a][b]:false
},getSurroundedTiles:function(e,c){var a=[];var g=this.getTile(e,c-1);var b=this.getTile(e,c+1);var f=this.getTile(e-1,c);
var d=this.getTile(e+1,c);if(g){a.push(g)}if(d){a.push(d)}if(b){a.push(b)}if(f){a.push(f)}return a},getObjects:function(b,a){return this._htObject[a]&&this._htObject[a][b]?this._htObject[a][b]:false
},getObject:function(d,b,e){if(this.hasObject(d,b)){for(var c=0,a=this._htObject[b][d].length;c<a;c++){if(e(this._htObject[b][d][c])===true){return this._htObject[b][d][c]
}}}return false},hasObject:function(e,c,f){var a=this._htObject[c]&&this._htObject[c][e]&&this._htObject[c][e].length;if(a&&f){for(var d=0,b=this._htObject[c][e].length;
d<b;d++){if(f(this._htObject[c][e][d])===true){return true}}return false}return a},_enterObject:function(d,b){var e=this.getObjects(d,b);
if(e){for(var c=0,a=e.length;c<a;c++){e[c].addTo(this._oObjectContainer)}}},_leaveObject:function(d,b){var e=this.getObjects(d,b);
if(e){for(var c=0,a=e.length;c<a;c++){e[c].leave()}}},getTileIndexToPos:function(b,a){return{x:b*this._nTileWidth,y:a*this._nTileHeight}
},getPosToTileIndex:function(b,a){return{tileX:Math.floor(b/this._nTileWidth),tileY:Math.floor(a/this._nTileHeight)}},_setterUseEvent:function(a){if(this._oLayer!==null){if(a){this._oLayer.attach("mousemove",this._fOnMousemove);
this._oLayer.attach("mouseup",this._fOnMouseup);this._oLayer.attach("mousedown",this._fOnMousedown);this._oLayer.attach("click",this._fOnClick)
}else{this._oLayer.detach("mousemove",this._fOnMousemove);this._oLayer.detach("mouseup",this._fOnMouseup);this._oLayer.detach("mousedown",this._fOnMousedown);
this._oLayer.detach("click",this._fOnClick)}}},_onMousemove:function(a){if(this._bIsMousedown&&this.fireEvent("mapmove",this._htEventInfo)!==false){this.setPosition(this._nStartContainerX+(a.x-this._nStartMouseX),this._nStartContainerY+(a.y-this._nStartMouseY))
}},_onMousedown:function(a){this._htEventInfo.eventX=a.x;this._htEventInfo.eventY=a.y;if(this.fireEvent("mapdown",this._htEventInfo)===false){return
}this._bIsMousedown=true;this._nStartMouseX=a.x;this._nStartMouseY=a.y;this._nStartContainerX=this._htContainerInfo.x;this._nStartContainerY=this._htContainerInfo.y;
if(this._htOption.useLiveUpdate&&(!this._htOption.useCache||this._sRenderingMode!=="canvas")){this._oTimerUpdate.start()}},_onMouseup:function(a){if(this._bIsMousedown){this._nStartMouseX=null;
this._nStartMouseY=null;this._nStartContainerX=null;this._nStartContainerY=null;this._bIsMousedown=false;if(this._htOption.useLiveUpdate){this._oTimerUpdate.pause()
}else{if(!this._htOption.useCache||this._sRenderingMode!=="canvas"){this._prepareTile()}}this._htEventInfo.eventX=a.x;this._htEventInfo.eventY=a.y;
this.fireEvent("mapup",this._htEventInfo)}},_onClick:function(b){var d=b.x-this._htContainerInfo.x;var c=b.y-this._htContainerInfo.y;
var a=this.getPosToTileIndex(d,c);this._htEventInfo.eventX=b.x;this._htEventInfo.eventY=b.y;this._htEventInfo.tileX=a.tileX;
this._htEventInfo.tileY=a.tileY;this.fireEvent("mapclick",this._htEventInfo)},_onResize:function(){this._oObjectContainer.set({width:this._oObjectLayer._htOption.width,height:this._oObjectLayer._htOption.height});
this._prepareStage()},_createTile:function(b,a){if((!this._htTile[a]||!this._htTile[a][b])&&this._aMapData[a]&&this._aMapData[a][b]){var c=this._oPool.get().addTo(this._oContainer);
c.set(this._aMapData[a][b]);this._htTile[a]=this._htTile[a]||{};this._htTile[a][b]=this._htTile[a][b]=c;this._aTiles.push(c);
this._enterObject(b,a)}},_releaseTiles:function(d,b,a,g){var f;var c=false;for(var e=0;e<this._aTiles.length;e++){f=this._aTiles[e];
if(d>f._htOption.tileX||f._htOption.tileX>a||b>f._htOption.tileY||f._htOption.tileY>g){delete this._htTile[f._htOption.tileY][f._htOption.tileX];
this._oPool.release(f);this._aTiles.splice(e,1);this._leaveObject(f._htOption.tileX,f._htOption.tileY);e--;c=true}}return c
},_prepareTileWithCache:function(){for(var b=0;b<this._nRowLength;b++){for(var a=0;a<this._nColLength;a++){this._createTile(a,b)
}}this.fireEvent("mapchange",this._htEventInfo)},_prepareTile:function(){if(!this._aMapData.length){return false}var d=Math.max(0,Math.floor(-this._htContainerInfo.x/this._nTileWidth)-this._htOption.cacheTileSize);
var b=Math.max(0,Math.floor(-this._htContainerInfo.y/this._nTileHeight)-this._htOption.cacheTileSize);var a=Math.min(this._nColLength-1,Math.floor((-this._htContainerInfo.x+this._htLayerOption.width)/this._nTileWidth)+this._htOption.cacheTileSize);
var h=Math.min(this._nRowLength-1,Math.floor((-this._htContainerInfo.y+this._htLayerOption.height)/this._nTileHeight)+this._htOption.cacheTileSize);
var f;this._htEventInfo.startTileX=d;this._htEventInfo.startTileY=b;this._htEventInfo.endTileX=a;this._htEventInfo.endTileY=h;
var c=this._releaseTiles(d,b,a,h);for(var g=b;g<=h;g++){for(var e=d;e<=a;e++){this._createTile(e,g)}}if(c){this.fireEvent("mapchange",this._htEventInfo)
}},getTileCountOnScreen:function(){var b=Math.ceil(this._htLayerOption.width/this._nTileWidth)+2;var a=Math.ceil(this._htLayerOption.height/this._nTileHeight)+2;
return b*a}},collie.Component);collie.PathFinding=collie.Class({$init:function(a,b){this._oMap=a;this._fBeforeMove=b},find:function(f,e,o,n){var d=Math.max(this._oMap.getTileCountOnScreen(),Math.pow(collie.util.getDistance(f,e,o,n)*2,2));
var a=0;var k=f;var g=e;var r=[];this._sFilter="";while(k!==o||g!==n){a++;if(a>d){return false}var j=this._oMap.getSurroundedTiles(k,g);
var q=null;var p=null;for(var h=0,c=j.length;h<c;h++){if(!j[h]||!this.beforeMove(j[h])||this._isInFilter(j[h])){continue}var b=collie.util.getDistance(j[h].tileX,j[h].tileY,o,n);
if(p===null||b<q){q=b;p=j[h]}}if(p!==null){k=p.tileX;g=p.tileY;r.push([k,g]);this._sFilter+="["+k+","+g+"]"}else{this._sFilter+="["+k+","+g+"]";
if(r.length>0){var m=r.pop();k=m[0];g=m[1];continue}else{return false}}}return(r.length>0)?r:false},beforeMove:function(a){return this._fBeforeMove(a,this._oMap)===false?false:true
},getMap:function(){return this._oMap},_isInFilter:function(a){return this._sFilter.indexOf("["+a.tileX+","+a.tileY+"]")!==-1
}},collie.Component);